<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>HUD Mapa Pro - GPS Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        :root { --hud-size: 85vw; --max-size: 550px; --gta-yellow: #f9ca24; }
        body { margin: 0; background: #25471E; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: none; }
        #wrapper { position: relative; width: var(--hud-size); height: var(--hud-size); max-width: var(--max-size); max-height: var(--max-size); }
        #hud { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 6px solid black; overflow: hidden; background: #38692d; z-index: 1; }
        #map { position: absolute; width: 100%; height: 100%; z-index: 1; }
        
        /* Estilo del marcador del jugador (Punto azul de GPS real) */
        .user-marker {
            width: 15px; height: 15px;
            background: #1e90ff; border: 3px solid white;
            border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #radio-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.7); width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.96) 20%, rgba(0,0,0,0.7) 80%); border-radius: 50%; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: all 0.3s; border: 4px solid var(--gta-yellow); }
        #radio-ui.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .station-icon-radial { position: absolute; width: 45px; height: 45px; transform: translate(-50%, -50%); filter: grayscale(1) opacity(0.4); transition: 0.2s; }
        .station-icon-radial.highlight { filter: grayscale(0) opacity(1); transform: translate(-50%, -50%) scale(1.3); }
        #station-logo { width: 100px; height: 100px; object-fit: contain; }
        #station-name { color: var(--gta-yellow); font-family: sans-serif; font-weight: bold; margin-top: 10px; }
        
        #north-orbit { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        #north { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: black; color: white; padding: 5px 10px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="wrapper">
    <div id="hud">
        <div id="map"></div>
        <div id="radio-ui">
            <img id="station-logo" src="img/RadioOff.png">
            <div id="station-name">RADIO OFF</div>
        </div>
    </div>
    <div id="north-orbit"><div id="north">N</div></div>
</div>

<audio id="radio-audio" loop></audio>

<script>
// 1. Inicializar Mapa con centro por defecto
const map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.openfreemap.org/styles/bright',
    center: [-70.6483, -33.4569],
    zoom: 16,
    attributionControl: false,
    interactive: false
});

// Marcador visual del jugador
const el = document.createElement('div');
el.className = 'user-marker';
const marker = new maplibregl.Marker({element: el}).setLngLat([-70.6483, -33.4569]).addTo(map);

// 2. Lógica de Radio (Simplificada para no interferir)
const stations = [
    { name: "Radio Off", logo: "img/RadioOff.png", file: "" },
    { name: "K-Rose", logo: "img/K-Rose.png", file: "https://www.dropbox.com/scl/fi/9rqncuwg57ytnhxgogxhw/K-Rose.ogg?rlkey=stkyv5gbrzgg16g1o020j0r8u&raw=1", duration: 2886 }
    // Agrega las demás aquí siguiendo el mismo formato raw=1
];

let currentIdx = 0;
const audio = document.getElementById('radio-audio');

function applyStation(idx) {
    currentIdx = idx;
    const s = stations[idx];
    if (s && s.file) {
        audio.src = s.file;
        audio.onloadedmetadata = () => {
            audio.currentTime = Math.floor(Date.now() / 1000) % s.duration;
            audio.play().catch(e => console.log("Esperando click"));
        };
    } else {
        audio.pause();
    }
}

// 3. GPS REAL (CORREGIDO)
function initGPS() {
    console.log("Iniciando GPS...");
    
    if (!navigator.geolocation) {
        alert("Tu navegador no soporta GPS");
        return;
    }

    // Solicitar posición actual y vigilar cambios
    navigator.geolocation.watchPosition(
        (pos) => {
            const { latitude, longitude } = pos.coords;
            console.log("Nueva posición:", latitude, longitude);
            
            // Mover el marcador
            marker.setLngLat([longitude, latitude]);
            
            // Centrar el mapa con suavidad
            map.easeTo({
                center: [longitude, latitude],
                duration: 1000,
                essential: true
            });
        },
        (err) => {
            alert("Error de GPS: " + err.message + ". Asegúrate de usar HTTPS y activar la ubicación.");
        },
        {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
        }
    );

    // Brújula
    if (window.DeviceOrientationEvent) {
        const orientHandler = (e) => {
            const heading = e.webkitCompassHeading || (e.alpha ? 360 - e.alpha : 0);
            map.setBearing(heading);
            document.getElementById('north-orbit').style.transform = `rotate(${-heading}deg)`;
        };

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(response => {
                if (response == 'granted') window.addEventListener('deviceorientation', orientHandler);
            });
        } else {
            window.addEventListener('deviceorientation', orientHandler);
        }
    }
}

// ACTIVACIÓN POR CLICK (Obligatorio en móviles)
document.body.addEventListener('click', () => {
    initGPS();
    // También activamos el audio si estaba pausado
    if (audio.src) audio.play();
}, { once: true });

</script>
</body>
</html>
