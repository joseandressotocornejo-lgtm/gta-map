<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>HUD Mapa Pro - GPS Alta Precisión</title>

<script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />

<style>
:root {
    --hud-size: 85vw;
    --max-size: 550px;
}

body {
    margin: 0;
    background: #e5e5e5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Segoe UI', Arial, sans-serif;
    overflow: visible;
    padding-top: 40px;
    box-sizing: border-box;
}

#wrapper {
    position: relative;
    width: var(--hud-size);
    height: var(--hud-size);
    max-width: var(--max-size);
    max-height: var(--max-size);
}

#hud {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: calc(var(--hud-size) * 0.015) solid black;
    overflow: hidden;
    background: #38692d;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1;
    box-sizing: border-box;
}

#map {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 1;
}

#player {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 7%;
    transform: translate(-50%, -50%) rotate(180deg);
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}

#north-orbit {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 20;
    pointer-events: none;
    transition: transform 0.1s linear;
}

#north {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    background: black;
    color: white;
    font-weight: bold;
    font-size: calc(var(--hud-size) * 0.05);
    padding: 1.5% 3.5%;
    border-radius: 100px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    white-space: nowrap;
}

@media (min-width: 650px) {
    #hud { border-width: 6px; }
    #north { font-size: 22px; padding: 6px 14px; }
}
</style>
</head>

<body onclick="requestPermissions()">

<div id="wrapper">
<div id="hud">
<div id="map"></div>

<svg id="player" viewBox="0 0 34 50">
<path d="M17 2 C9 2 3 10 3 18 C3 30 17 45 17 45 C17 45 31 30 31 18 C31 10 25 2 17 2 Z"
fill="white" stroke="black" stroke-width="4"/>
</svg>
</div>

<div id="north-orbit">
<div id="north">N</div>
</div>
</div>

<script>
const paleta = {
agua: '#7088b0',
tierra_general: '#38692d',
urbano: '#989898',
parques: '#788c40',
edificios: '#FFFFFF',
calles_negras: '#000000',
senderos_marron: '#A78C6A'
};

const map = new maplibregl.Map({
container: 'map',
style: 'https://tiles.openfreemap.org/styles/bright',
center: [-70.6483, -33.4569],
zoom: 18,
pitch: 0,
bearing: 0,
attributionControl: false,
interactive: false
});

map.on('style.load', () => {
map.setPaintProperty('background', 'background-color', paleta.tierra_general);

if (map.getLayer('building')) {
map.setPaintProperty('building', 'fill-color', paleta.edificios);
map.setPaintProperty('building', 'fill-outline-color', '#000000');
}

map.getStyle().layers.forEach(layer => {
if (map.getLayer('water'))
map.setPaintProperty('water', 'fill-color', paleta.agua);

if (map.getLayer('park'))
map.setPaintProperty('park', 'fill-color', paleta.parques);

const esVia = layer.id.includes('highway') ||
layer.id.includes('bridge') ||
layer.id.includes('tunnel');

if (layer.type === 'line' && esVia) {
const esSendero = layer.id.includes('path') ||
layer.id.includes('footway') ||
layer.id.includes('track');

if (esSendero) {
map.setPaintProperty(layer.id, 'line-color', paleta.senderos_marron);
map.setPaintProperty(layer.id, 'line-width', 3);
} else {
map.setPaintProperty(layer.id, 'line-color', paleta.calles_negras);
map.setPaintProperty(layer.id, 'line-width',
['interpolate', ['linear'], ['zoom'], 14, 2, 18, 10]);
}
}
});
});

/* GPS SUAVIZADO */
const geoOptions = {
enableHighAccuracy: true,
timeout: 15000,
maximumAge: 0
};

let smoothLat = null;
let smoothLng = null;
const smoothing = 0.18;

function smoothGPS(lat, lng) {
if (smoothLat === null) {
smoothLat = lat;
smoothLng = lng;
} else {
smoothLat = smoothLat * (1 - smoothing) + lat * smoothing;
smoothLng = smoothLng * (1 - smoothing) + lng * smoothing;
}
return [smoothLat, smoothLng];
}

function startTracking() {
navigator.geolocation.watchPosition(pos => {

const rawLat = pos.coords.latitude;
const rawLng = pos.coords.longitude;
const speed = pos.coords.speed;

const [lat, lng] = smoothGPS(rawLat, rawLng);

const speedKmh = speed ? speed * 3.6 : 0;
let dynamicZoom = 18 - (speedKmh / 25);

if (dynamicZoom < 15.5) dynamicZoom = 15.5;
if (dynamicZoom > 18) dynamicZoom = 18;

map.easeTo({
center: [lng, lat],
zoom: dynamicZoom,
duration: 900
});

}, err => console.error("Error GPS:", err), geoOptions);
}

/* Brújula CORREGIDA */
let smoothHeading = 0;
const headingSmooth = 0.15;

function handleOrientation(event) {
let rawHeading;

if (event.webkitCompassHeading !== undefined) {
rawHeading = event.webkitCompassHeading;
} else if (event.alpha !== null) {
rawHeading = 360 - event.alpha;
}

if (rawHeading === undefined) return;

smoothHeading =
smoothHeading * (1 - headingSmooth) +
rawHeading * headingSmooth;

map.setBearing(smoothHeading);
document.getElementById('north-orbit').style.transform =
`rotate(${-smoothHeading}deg)`;
}

function requestPermissions() {
startTracking();

if (typeof DeviceOrientationEvent !== 'undefined' &&
typeof DeviceOrientationEvent.requestPermission === 'function') {
DeviceOrientationEvent.requestPermission()
.then(response => {
if (response === 'granted') {
window.addEventListener('deviceorientation', handleOrientation);
}
})
.catch(console.error);
} else {
window.addEventListener('deviceorientation', handleOrientation);
}
}
</script>

</body>
</html>
